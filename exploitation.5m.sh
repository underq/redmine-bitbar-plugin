#!/bin/bash

# Redmine issue counter
# BitBar plugin
#
# Shows current issue counter and ğŸ‘ / ğŸ‘ on change

dir=$(dirname "$0")
source "$dir/params.sh"
# file used to persist actual counter. set to 0 if file doesn't exist
if [ ! -f "/tmp/redminecounter.dat" ] ; then
  OLDCOUNT=0
else
  OLDCOUNT=$(cat /tmp/redminecounter.dat) # read value from file
fi

NEWCOUNT=$(curl -s --compressed -H "X-Redmine-API-Key: $APIKEY" $URI | egrep -o '"total_count":([0-9])+' | sed 's/"total_count"://')

if [ "$NEWCOUNT" -gt "$OLDCOUNT" ] ; then
  echo ğŸ‘ ğŸŒµ
elif [ "$OLDCOUNT" -gt "$NEWCOUNT" ] ; then
  echo ğŸ‘ ğŸŒµ
else
  echo $NEWCOUNTğŸŒµ 
fi

echo $NEWCOUNT > /tmp/redminecounter.dat # write new counter to file
